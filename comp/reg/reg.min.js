angular.module("app",[]),angular.module("app").controller("WizardController",[function(){var o=this;o.thisYear=(new Date).getFullYear();var a=["bagpipes","snare","tenor","bass"],n=[{name:"acknowledge"},{name:"payment"}],r=[{name:"step1"},{name:"competition",context:"competition"},{name:"bagpipes",context:"competition"},{name:"snare",context:"competition"},{name:"tenor",context:"competition"},{name:"bass",context:"competition"},{name:"workshop"},{name:"confirm"}];function s(e){o.paymentError=!0,o.paymentErrorMessage=e.message,o.refresh()}function t(){o.rating=0,o.hoverRating=0,o.feedback="",o.currentStepIndex=0,o.registrantIndex=0,o.currentFormName="step1Form",o.currentStepName="step1",o.steps=[],c(),function(){for(var e=0;e<n.length;e++)u(n[e],o.steps.length)}(),o.user=i(),o.users=[]}function i(){var t={comp:{},workshopPref:{}};return a.forEach(function(e){t.comp[e]={}}),t}function c(){for(var e=0===o.registrantIndex?0:o.steps.length-n.length,t=0;t<r.length;t++)u(r[t],t+e)}function u(e,t){var n=e.name;o.steps.splice(t,0,{registrantIndex:o.registrantIndex,stepIndex:t,name:n,template:n+".html?v1.0.2.0",formName:n+"Form",context:e.context,stepEnabled:!0})}t(),o.gotoStep=function(e){"step1"===o.steps[o.currentStepIndex].name?(o.steps.filter(function(e){return e.registrantIndex===o.registrantIndex&&"competition"===e.context}).forEach(function(e){e.stepEnabled=o.user.competition}),o.steps.filter(function(e){return e.registrantIndex===o.registrantIndex&&"workshop"===e.name})[0].stepEnabled=o.user.workshop):"competition"===o.steps[o.currentStepIndex].name?function(){for(var t=0;t<a.length;t++)o.steps.filter(function(e){return e.registrantIndex===o.registrantIndex&&e.name===a[t]})[0].stepEnabled=o.user.comp[a[t]].checked}():"confirm"===o.steps[o.currentStepIndex].name&&"No"!==(o.user.confirmAnother||"No")&&"Yes"===o.user.confirmAnother&&(o.registrantIndex++,c(),o.user=i());for(var t=o.currentStepIndex+e;!o.steps[t].stepEnabled;)t+=e;o.currentStepIndex=t,o.currentFormName=o.steps[t].formName,o.currentStepName=o.steps[t].name,"confirm"===o.currentStepName&&(o.users[o.registrantIndex]=angular.copy(o.user))},o.stepLoaded=function(){document.location="#","payment"===o.currentStepName&&setTimeout(o.renderPayPalButtons,250)},o.renderPayPalButtons=function(){paypal.Buttons({createOrder:function(e,t){return t.order.create({purchase_units:[{amount:{name:"Cincinnati Indoor Solo Competition & Workshop",value:o.total}}]})},onApprove:function(e,t){return t.order.capture().then(function(e){o.paid=!0,o.refresh(),fetch("https://ujknic9ujb.execute-api.us-east-1.amazonaws.com/default/lambda-sendemail-ses",{method:"POST",mode:"cors",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify({toEmails:["andrew.douglas11@gmail.com"],subject:"Indoor Competition Registration",message:JSON.stringify({registration:{users:o.users,totalCost:o.total,paid:o.paid,acknowledge:o.acknowledge}},null,2)})}).then(function(){console.log("email sent successfully")}).catch(function(e){console.error("Error sending email: "+e.message)})}).catch(s)},onError:s}).render("#paypal-button-container")},o.showNavButtons=function(){return"payment"!==o.currentStepName},o.refresh=function(){angular.element($("#wizard-content-container")).scope().$apply()},o.getStepTemplate=function(){return o.steps[o.currentStepIndex].template},o.disableNextButton=function(){return o[o.currentFormName]&&o[o.currentFormName].$invalid},o.displayYesNo=function(e){return o.user[e]?"Yes":"No"},o.getEvents=function(e,t){if(!e.comp[t].checked)return"";var n=[];for(var r in e.comp[t].events)n.push(e.comp[t].events[r]);return n.join(", ")},o.startOver=function(){var e;confirm("Are you sure you want to start completely over?")&&(t(),setTimeout(function(){document.location="#"},e||1))},o.showAllNames=function(){return o.users.map(function(e){return e.name}).join(", ")},o.perEventCost=10,o.allEventsCost=30,o.workshopCost=30,o.eventDiscount=10,o.typicalMax=o.allEventsCost+o.workshopCost-o.eventDiscount,o.getEventCost=function(e){for(var t=0,n=0;n<a.length;n++)if(e.comp[a[n]].checked){var r=o.getEvents(e,a[n]).split(", ").length;t+=r*o.perEventCost<o.allEventsCost?r*o.perEventCost:o.allEventsCost}return e.competitionCost=t},o.displayWorkshopCost=function(e){return e.workshopCost=(e.competitionCost||0)>=o.allEventsCost?o.workshopCost-o.eventDiscount:o.workshopCost,e.workshopCost},o.displayTotalCost=function(){for(var e=0,t=0;t<o.users.length;t++)e+=(o.users[t].competitionCost||0)+(o.users[t].workshop&&o.users[t].workshopCost||0);return o.total=e}}]).directive("starRating",function(){return{restrict:"A",template:'<label>Please rate your registration experience:</label><ul class="rating"> <li ng-repeat="star in stars" ng-class="{\'filled\': isFilled($index), \'hovered\': isHovered($index)}" ng-click="toggle($index)" ng-mouseover="over($index)" ng-mouseout="out()">  <i class="fa fa-star"></i> </li></ul><span>{{getRatingText()}}</span><div ng-show="showTextarea()">\t<label>Do you have suggestions on how we can improve this registration experience?</label>\t<textarea ng-model="feedback" class="form-control"></textarea></div><div ng-show="!feedbackSent"> <br /><button ng-disabled="!ratingValue" ng-click="sendFeedback()" type="button" class="btn btn-success"> <i class="fa fa-send-o"></i> Send Feedback</button></div><div ng-show="feedbackSent"> Thank you for providing feedback!</div>',scope:{ratingText:"=",ratingTextDelimiter:"=",ratingValue:"=",hoverValue:"=",feedback:"=",max:"="},link:function(t,e,n){t.stars=Array.apply(null,Array(t.max)).map(function(){return{}}),t.isFilled=function(e){return e<t.ratingValue},t.isHovered=function(e){return e<t.hoverValue&&e>=t.ratingValue},t.over=function(e){t.hoverValue=e+1},t.out=function(){t.hoverValue=0},t.showTextarea=function(){return 0<t.ratingValue&&t.ratingValue<t.max},t.getRatingText=function(){return 0===(t.ratingValue||t.hoverValue)?"":t.ratingText.split(t.ratingTextDelimiter)[(t.ratingValue||t.hoverValue)-1]},t.toggle=function(e){t.ratingValue=e+1,t.hoverValue=0},t.sendFeedback=function(){fetch("https://ujknic9ujb.execute-api.us-east-1.amazonaws.com/default/lambda-sendemail-ses",{method:"POST",mode:"cors",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify({toEmails:["andrew.douglas11@gmail.com"],subject:"Indoor Reg Feedback",message:JSON.stringify({feedback:{name:t.$parent.vm.users[0].name,email:t.$parent.vm.users[0].email,rating:t.$parent.vm.rating,feedback:t.$parent.vm.feedback}},null,2)})}).then(function(){t.feedbackSent=!0,t.$parent.vm.refresh()}).catch(function(e){console.error(e),t.feedbackSent=!0,t.$parent.vm.refresh()})}}}});